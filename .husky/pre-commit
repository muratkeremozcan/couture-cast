#!/bin/sh
. "$(dirname "$0")/_/husky.sh"

# Check if mobile app code changed
MOBILE_CHANGES=$(git diff --cached --name-only | grep '^apps/mobile/' | grep -v '^apps/mobile/android/' | grep -v '^apps/mobile/ios/' | grep -v '.gitignore' || true)

if [ -n "$MOBILE_CHANGES" ]; then
  echo "⚠️  Mobile app code changed. Checking if binaries need rebuilding..."

  # Check if binaries exist and are staged
  ANDROID_STAGED=$(git diff --cached --name-only | grep 'apps/mobile/android/app/build/outputs/apk/debug/app-debug.apk' || true)
  IOS_STAGED=$(git diff --cached --name-only | grep 'apps/mobile/ios/build/Build/Products/Debug-iphonesimulator/mobile.app' || true)

  if [ -z "$ANDROID_STAGED" ] && [ -z "$IOS_STAGED" ]; then
    echo ""
    echo "❌ Mobile code changed but binaries not updated!"
    echo ""
    echo "You MUST rebuild mobile binaries for CI:"
    echo "  ./scripts/build-mobile-binaries.sh"
    echo "  git add apps/mobile/android apps/mobile/ios"
    echo ""
    echo "Or bypass this check if intentional:"
    echo "  git commit --no-verify"
    echo ""
    exit 1
  fi

  echo "✅ Mobile binaries updated"
fi

# Run lint-staged
npx lint-staged
