name: "Reusable E2E (Playwright)"
run-name: E2E - ${{ inputs.test_env }} - ${{ inputs.test_command }}

on:
  workflow_call:
    inputs:
      test_env:
        type: string
        description: "Test environment (local|dev|prod)"
        required: true
      test_command:
        type: string
        description: "Playwright command to run (e.g., npm run test:pw-dev)"
        required: true
      gh_ref:
        type: string
        description: "Ref to checkout"
        required: false
        default: ${{ github.sha }}
      custom_base_url:
        type: string
        description: "Optional override for base URL"
        required: false
      deployment_ref:
        type: string
        description: "Git ref from deployment event (branch name)"
        required: false
    secrets:
      VERCEL_AUTOMATION_BYPASS_SECRET:
        required: false
      VERCEL_TOKEN:
        required: false
      VERCEL_API_PROJECT_SLUG:
        required: false
      VERCEL_TEAM_SLUG:
        required: false

jobs:
  e2e:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    permissions:
      contents: read
      id-token: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.gh_ref }}

      - name: Resolve expected SHA
        id: expected_sha
        shell: bash
        run: echo "sha=$(git rev-parse HEAD)" >> "$GITHUB_OUTPUT"

      - name: Setup Node + deps
        uses: ./.github/actions/install

      - name: Setup Playwright browsers
        uses: ./.github/actions/setup-playwright-browsers

      - name: Resolve branch name from SHA
        id: resolve_branch
        if: inputs.deployment_ref != ''
        shell: bash
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          # deployment_ref might be a SHA, not a branch name
          # Query GitHub API to find which branch has this commit as HEAD
          sha="${{ inputs.gh_ref }}"
          deployment_ref="${{ inputs.deployment_ref }}"

          branch_name=""

          # If deployment_ref looks like a branch name (not a 40-char hex), use it directly
          if [[ "$deployment_ref" =~ ^[a-f0-9]{40}$ ]]; then
            echo "deployment_ref is a SHA, querying GitHub for branch name..."
            # Query GitHub API for branches where this SHA is HEAD
            branch_name=$(gh api "/repos/${{ github.repository }}/commits/${sha}/branches-where-head" --jq '.[0].name' 2>/dev/null || true)

            # Fallback: check if this is a PR and get head ref
            if [ -z "$branch_name" ]; then
              # Try to find PR associated with this SHA
              pr_branch=$(gh api "/repos/${{ github.repository }}/commits/${sha}/pulls" --jq '.[0].head.ref' 2>/dev/null || true)
              if [ -n "$pr_branch" ]; then
                branch_name="$pr_branch"
              fi
            fi
          else
            # deployment_ref is already a branch name
            branch_name="$deployment_ref"
          fi

          echo "Resolved branch name: $branch_name"
          echo "branch=$branch_name" >> "$GITHUB_OUTPUT"

      - name: Run Playwright
        shell: bash
        env:
          TEST_ENV: ${{ inputs.test_env }}
          EXPECTED_SHA: ${{ steps.expected_sha.outputs.sha }}
          GITHUB_SHA: ${{ steps.expected_sha.outputs.sha }}
          GH_TOKEN: ${{ github.token }}
          VERCEL_AUTOMATION_BYPASS_SECRET: ${{ secrets.VERCEL_AUTOMATION_BYPASS_SECRET }}
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
          VERCEL_WEB_PROJECT_SLUG: ${{ secrets.VERCEL_WEB_PROJECT_SLUG }}
          VERCEL_API_PROJECT_SLUG: ${{ secrets.VERCEL_API_PROJECT_SLUG }}
          VERCEL_TEAM_SLUG: ${{ secrets.VERCEL_TEAM_SLUG }}
          # Pass resolved branch name for URL construction
          VERCEL_GIT_COMMIT_REF: ${{ steps.resolve_branch.outputs.branch }}
          # Enable debug logging for URL resolution scripts
          DEBUG: true
        run: |
          custom_base_url="${{ inputs.custom_base_url }}"
          if [ -n "$custom_base_url" ]; then
            case "${{ inputs.test_env }}" in
              local) export WEB_E2E_BASE_URL="$custom_base_url" ;;
              dev) export DEV_WEB_E2E_BASE_URL="$custom_base_url" ;;
              prod) export PROD_WEB_E2E_BASE_URL="$custom_base_url" ;;
            esac

            # Resolve API URL using Vercel REST API
            if [ -z "$DEV_API_BASE_URL" ] && [ -z "$VERCEL_API_BASE_URL" ]; then
              echo "Resolving API preview URL via Vercel REST API..."
              api_url=$(node scripts/resolve-api-preview-url.mjs 2>&1)
              if [ $? -eq 0 ] && [ -n "$api_url" ]; then
                echo "Resolved API URL: $api_url"
                export DEV_API_BASE_URL="$api_url"
                export VERCEL_API_BASE_URL="$api_url"
              else
                echo "Warning: Could not resolve API URL from Vercel API"
                echo "Error output: $api_url"
              fi
            fi
          fi

          # DEBUG env var already set at workflow level
          ${{ inputs.test_command }}

      - name: Upload Playwright artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: pw-artifacts-${{ inputs.test_env }}
          path: |
            playwright/artifacts/**
            playwright/playwright-report/**
          retention-days: 5
