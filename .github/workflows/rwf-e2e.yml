name: "Reusable E2E (Playwright)"
run-name: E2E - ${{ inputs.test_env }} - ${{ inputs.test_command }}

on:
  workflow_call:
    inputs:
      test_env:
        type: string
        description: "Test environment (local|dev|prod)"
        required: true
      test_command:
        type: string
        description: "Playwright command to run (e.g., npm run test:pw-dev)"
        required: true
      gh_ref:
        type: string
        description: "Ref to checkout"
        required: false
        default: ${{ github.sha }}
      custom_base_url:
        type: string
        description: "Optional override for base URL"
        required: false
      deployment_ref:
        type: string
        description: "Deployment ref (branch) for preview URL derivation"
        required: false
    secrets:
      VERCEL_AUTOMATION_BYPASS_SECRET:
        required: false

jobs:
  e2e:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    permissions:
      contents: read
      id-token: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.gh_ref }}

      - name: Resolve expected SHA
        id: expected_sha
        shell: bash
        run: echo "sha=$(git rev-parse HEAD)" >> "$GITHUB_OUTPUT"

      - name: Setup Node + deps
        uses: ./.github/actions/install

      - name: Setup Playwright browsers
        uses: ./.github/actions/setup-playwright-browsers

      - name: Run Playwright
        shell: bash
        env:
          TEST_ENV: ${{ inputs.test_env }}
          EXPECTED_SHA: ${{ steps.expected_sha.outputs.sha }}
          GITHUB_SHA: ${{ steps.expected_sha.outputs.sha }}
          VERCEL_AUTOMATION_BYPASS_SECRET: ${{ secrets.VERCEL_AUTOMATION_BYPASS_SECRET }}
        run: |
          custom_base_url="${{ inputs.custom_base_url }}"
          if [ -n "$custom_base_url" ]; then
            case "${{ inputs.test_env }}" in
              local) export WEB_E2E_BASE_URL="$custom_base_url" ;;
              dev) export DEV_WEB_E2E_BASE_URL="$custom_base_url" ;;
              prod) export PROD_WEB_E2E_BASE_URL="$custom_base_url" ;;
            esac
          fi

          # Derive API preview URL from deployment ref if not already provided.
          if [ -z "$DEV_API_BASE_URL" ] && [ -z "$VERCEL_API_BASE_URL" ]; then
            ref="${{ inputs.deployment_ref }}"
            slug=$(echo "${ref#refs/heads/}" | tr '[:upper:]' '[:lower:]' | sed -e 's/[^a-z0-9]/-/g' -e 's/^-*//' -e 's/-*$//')
            if [ -n "$slug" ]; then
              api_slug="${VERCEL_API_PROJECT_SLUG:-couture-cast-api}"
              team_slug="${VERCEL_TEAM_SLUG:-muratkeremozcans-projects}"
              export DEV_API_BASE_URL="https://${api_slug}-git-${slug}-${team_slug}.vercel.app"
            fi
          fi

          ${{ inputs.test_command }}

      - name: Upload Playwright artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: pw-artifacts-${{ inputs.test_env }}
          path: |
            playwright/artifacts/**
            playwright/playwright-report/**
          retention-days: 5
