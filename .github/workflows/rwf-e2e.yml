name: "Reusable E2E (Playwright)"
run-name: E2E - ${{ inputs.test_env }} - ${{ inputs.test_command }}

on:
  workflow_call:
    inputs:
      test_env:
        type: string
        description: "Test environment (local|dev|prod)"
        required: true
      test_command:
        type: string
        description: "Playwright command to run (e.g., npm run test:pw-dev)"
        required: true
      gh_ref:
        type: string
        description: "Ref to checkout"
        required: false
        default: ${{ github.sha }}
      custom_base_url:
        type: string
        description: "Optional override for base URL"
        required: false
    secrets:
      VERCEL_AUTOMATION_BYPASS_SECRET:
        required: false

jobs:
  e2e:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    permissions:
      contents: read
      id-token: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.gh_ref }}

      - name: Resolve expected SHA
        id: expected_sha
        shell: bash
        run: echo "sha=$(git rev-parse HEAD)" >> "$GITHUB_OUTPUT"

      - name: Setup Node + deps
        uses: ./.github/actions/install

      - name: Setup Playwright browsers
        uses: ./.github/actions/setup-playwright-browsers

      - name: Run Playwright
        shell: bash
        env:
          TEST_ENV: ${{ inputs.test_env }}
          EXPECTED_SHA: ${{ steps.expected_sha.outputs.sha }}
          GITHUB_SHA: ${{ steps.expected_sha.outputs.sha }}
          VERCEL_AUTOMATION_BYPASS_SECRET: ${{ secrets.VERCEL_AUTOMATION_BYPASS_SECRET }}
        run: |
          custom_base_url="${{ inputs.custom_base_url }}"
          if [ -n "$custom_base_url" ]; then
            case "${{ inputs.test_env }}" in
              local) export WEB_E2E_BASE_URL="$custom_base_url" ;;
              dev) export DEV_WEB_E2E_BASE_URL="$custom_base_url" ;;
              prod) export PROD_WEB_E2E_BASE_URL="$custom_base_url" ;;
            esac

            # Derive API base from the same host when not provided.
            if [ -z "$DEV_API_BASE_URL" ] && [ -z "$VERCEL_API_BASE_URL" ]; then
              api_slug="${VERCEL_API_PROJECT_SLUG:-couture-cast-api}"
              team_slug="${VERCEL_TEAM_SLUG:-muratkeremozcans-projects}"

              host=$(echo "$custom_base_url" | sed -e 's#^https\?://##' -e 's#/.*$##')
              suffix="${team_slug}.vercel.app"
              api_host=""

              if [[ "$host" == *"$suffix" ]]; then
                prefix="${host%-$suffix}"
                if [[ "$prefix" == *"-git-"* ]]; then
                  branch="${prefix##*-git-}"
                  api_host="${api_slug}-git-${branch}-${team_slug}.vercel.app"
                else
                  id="${prefix##*-}"
                  api_host="${api_slug}-${id}-${team_slug}.vercel.app"
                fi
              fi

              # Fallback: derive from branch ref when host parsing fails.
              if [ -z "$api_host" ] && [ -n "$GITHUB_REF" ]; then
                branch_slug=$(echo "$GITHUB_REF" | sed -e 's#refs/heads/##' -e 's#refs/pull/##' -e 's#/merge##' | tr '[:upper:]' '[:lower:]' | sed -e 's/[^a-z0-9]/-/g' -e 's/^-*//' -e 's/-*$//')
                if [ -n "$branch_slug" ]; then
                  api_host="${api_slug}-git-${branch_slug}-${team_slug}.vercel.app"
                fi
              fi

              if [ -n "$api_host" ]; then
                export DEV_API_BASE_URL="https://${api_host}"
                export VERCEL_API_BASE_URL="https://${api_host}"
              fi
            fi
          fi

          ${{ inputs.test_command }}

      - name: Upload Playwright artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: pw-artifacts-${{ inputs.test_env }}
          path: |
            playwright/artifacts/**
            playwright/playwright-report/**
          retention-days: 5
