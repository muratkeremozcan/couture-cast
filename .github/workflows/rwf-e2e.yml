name: "Reusable E2E (Playwright)"
run-name: E2E - ${{ inputs.test_env }} - ${{ inputs.test_command }}

on:
  workflow_call:
    inputs:
      test_env:
        type: string
        description: "Test environment (local|dev|prod)"
        required: true
      test_command:
        type: string
        description: "Playwright command to run (e.g., npm run test:pw-dev)"
        required: true
      gh_ref:
        type: string
        description: "Ref to checkout"
        required: false
        default: ${{ github.sha }}
      custom_base_url:
        type: string
        description: "Optional override for base URL"
        required: false
    secrets:
      VERCEL_AUTOMATION_BYPASS_SECRET:
        required: false
      VERCEL_TOKEN:
        required: false
      VERCEL_API_PROJECT_SLUG:
        required: false
      VERCEL_TEAM_SLUG:
        required: false

jobs:
  e2e:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    permissions:
      contents: read
      id-token: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.gh_ref }}

      - name: Resolve expected SHA
        id: expected_sha
        shell: bash
        run: echo "sha=$(git rev-parse HEAD)" >> "$GITHUB_OUTPUT"

      - name: Setup Node + deps
        uses: ./.github/actions/install

      - name: Setup Playwright browsers
        uses: ./.github/actions/setup-playwright-browsers

      - name: Run Playwright
        shell: bash
        env:
          TEST_ENV: ${{ inputs.test_env }}
          EXPECTED_SHA: ${{ steps.expected_sha.outputs.sha }}
          GITHUB_SHA: ${{ steps.expected_sha.outputs.sha }}
          VERCEL_AUTOMATION_BYPASS_SECRET: ${{ secrets.VERCEL_AUTOMATION_BYPASS_SECRET }}
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
          VERCEL_API_PROJECT_SLUG: ${{ secrets.VERCEL_API_PROJECT_SLUG }}
          VERCEL_TEAM_SLUG: ${{ secrets.VERCEL_TEAM_SLUG }}
        run: |
          custom_base_url="${{ inputs.custom_base_url }}"
          if [ -n "$custom_base_url" ]; then
            case "${{ inputs.test_env }}" in
              local) export WEB_E2E_BASE_URL="$custom_base_url" ;;
              dev) export DEV_WEB_E2E_BASE_URL="$custom_base_url" ;;
              prod) export PROD_WEB_E2E_BASE_URL="$custom_base_url" ;;
            esac

            # Resolve API URL by querying Vercel API directly (web and API have different hashes)
            if [ -z "$DEV_API_BASE_URL" ] && [ -z "$VERCEL_API_BASE_URL" ]; then
              api_slug="${VERCEL_API_PROJECT_SLUG:-couture-cast-api}"
              team_slug="${VERCEL_TEAM_SLUG:-muratkeremozcans-projects}"

              if [ -n "$VERCEL_TOKEN" ] && [ -n "$api_slug" ]; then
                echo "Querying Vercel API for $api_slug deployments..."

                # Get branch slug from GITHUB_REF
                branch_slug=""
                if [ -n "$GITHUB_REF" ]; then
                  branch_slug=$(echo "$GITHUB_REF" | sed -e 's#refs/heads/##' -e 's#refs/pull/##' -e 's#/merge##' | tr '[:upper:]' '[:lower:]' | sed -e 's/[^a-z0-9]/-/g' -e 's/^-*//' -e 's/-*$//')
                fi

                # Query Vercel API for API project deployments
                api_url=""
                scope_arg=""
                if [ -n "$team_slug" ]; then
                  scope_arg="--scope $team_slug"
                fi

                # Try to get deployments from Vercel API
                deployments=$(npx vercel deployments "$api_slug" --json --limit 10 $scope_arg 2>/dev/null || echo "[]")

                if [ "$deployments" != "[]" ] && [ -n "$deployments" ]; then
                  # Extract first READY deployment URL
                  api_url=$(echo "$deployments" | node -e "
                    const data = JSON.parse(require('fs').readFileSync(0, 'utf8'));
                    if (Array.isArray(data)) {
                      const ready = data.find(d => d.url && (!d.state || d.state === 'READY'));
                      if (ready?.url) {
                        const url = ready.url.startsWith('http') ? ready.url : 'https://' + ready.url;
                        console.log(url);
                      }
                    }
                  " 2>/dev/null || true)
                fi

                # Fallback to deterministic branch URL if API query failed
                if [ -z "$api_url" ] && [ -n "$branch_slug" ] && [ -n "$team_slug" ]; then
                  echo "Falling back to deterministic branch URL..."
                  api_url="https://${api_slug}-git-${branch_slug}-${team_slug}.vercel.app"
                fi

                # Verify the API URL returns JSON, not HTML
                if [ -n "$api_url" ]; then
                  echo "Testing API URL: $api_url"
                  content_type=$(curl -s -o /dev/null -w "%{content_type}" --max-time 5 "${api_url}/api/health" 2>/dev/null || true)
                  if [[ "$content_type" == *"text/html"* ]]; then
                    echo "Warning: $api_url returns HTML, likely wrong endpoint"
                    api_url=""
                  fi
                fi

                if [ -n "$api_url" ]; then
                  echo "Using API URL: $api_url"
                  export DEV_API_BASE_URL="$api_url"
                  export VERCEL_API_BASE_URL="$api_url"
                else
                  echo "Warning: Could not resolve API URL"
                fi
              fi
            fi
          fi

          ${{ inputs.test_command }}

      - name: Upload Playwright artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: pw-artifacts-${{ inputs.test_env }}
          path: |
            playwright/artifacts/**
            playwright/playwright-report/**
          retention-days: 5
