name: "Wait for Vercel deployment"

# Vercel-specific wrapper: handles authentication bypass for protected previews
# Keeps the generic rwf-wait-for-deployment.yml clean and platform-agnostic

on:
  workflow_call:
    inputs:
      health_url:
        description: "Health endpoint URL to poll (must return JSON with .status and .gitSha)"
        type: string
        required: true
      expected_sha:
        description: "Commit SHA to match (first 7 chars)"
        type: string
        required: true
      retries:
        description: "Max polling attempts"
        type: number
        required: false
        default: 20
      sleep_seconds:
        description: "Delay between attempts (seconds)"
        type: number
        required: false
        default: 30
    secrets:
      vercel_bypass_secret:
        description: "Vercel authentication bypass secret for protected deployments"
        required: true

jobs:
  wait:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    outputs:
      observed_sha: ${{ steps.health_check.outputs.observed_sha }}
    steps:
      - name: Wait for health + SHA with Vercel bypass
        id: health_check
        env:
          HEALTH_URL: ${{ inputs.health_url }}
          EXPECTED_SHA: ${{ inputs.expected_sha }}
          RETRIES: ${{ inputs.retries }}
          SLEEP_SECONDS: ${{ inputs.sleep_seconds }}
          VERCEL_BYPASS_SECRET: ${{ secrets.vercel_bypass_secret }}
        run: |
          # Add Vercel bypass token to URL within this job (never crosses job boundary)
          if [[ "${HEALTH_URL}" == *"?"* ]]; then
            CHECK_URL="${HEALTH_URL}&x-vercel-set-bypass-cookie=true&x-vercel-protection-bypass=${VERCEL_BYPASS_SECRET}"
          else
            CHECK_URL="${HEALTH_URL}?x-vercel-set-bypass-cookie=true&x-vercel-protection-bypass=${VERCEL_BYPASS_SECRET}"
          fi

          echo "Waiting for deployment at ${HEALTH_URL} (with Vercel bypass)"
          EXPECTED_SHORT="${EXPECTED_SHA:0:7}"

          MATCHED=false

          for i in $(seq 1 "${RETRIES}"); do
            RESPONSE=$(curl -s -f "${CHECK_URL}" || true)

            if [ -z "${RESPONSE}" ]; then
              echo "⏳ Waiting for health... (attempt ${i}/${RETRIES})"
              sleep "${SLEEP_SECONDS}"
              continue
            fi

            STATUS=$(echo "${RESPONSE}" | jq -r '.status // "unknown"')
            DEPLOYED_SHA=$(echo "${RESPONSE}" | jq -r '.gitSha // "unknown"')
            DEPLOYED_SHORT="${DEPLOYED_SHA:0:7}"

            if [ "${STATUS}" != "ok" ]; then
              echo "⏳ Health endpoint not ready (status=${STATUS})... (attempt ${i}/${RETRIES})"
              sleep "${SLEEP_SECONDS}"
              continue
            fi

            if [ "${DEPLOYED_SHA}" = "unknown" ]; then
              echo "⏳ Health OK but gitSha unknown... retrying (attempt ${i}/${RETRIES})"
              sleep "${SLEEP_SECONDS}"
              continue
            fi

            if [ "${DEPLOYED_SHORT}" = "${EXPECTED_SHORT}" ]; then
              echo "✅ Deployment healthy with expected SHA: ${DEPLOYED_SHORT}"
              MATCHED=true
              break
            fi

            echo "⏳ Health OK but waiting for correct deployment... (attempt ${i}/${RETRIES})"
            echo "   Expected SHA: ${EXPECTED_SHORT}"
            echo "   Deployed SHA: ${DEPLOYED_SHORT}"
            sleep "${SLEEP_SECONDS}"
          done

          # Final verification
          if ! curl -f "${CHECK_URL}" > /dev/null; then
            echo "❌ Deployment failed to become healthy after waiting."
            exit 1
          fi

          FINAL_SHA=$(curl -s -f "${CHECK_URL}" | jq -r '.gitSha // "unknown"')
          echo "observed_sha=${FINAL_SHA}" >> "$GITHUB_OUTPUT"

          if [ "${MATCHED}" = "false" ]; then
            if [ "${FINAL_SHA}" = "unknown" ]; then
              echo "❌ Deployment never reported gitSha; refusing to continue without SHA match."
              exit 1
            fi

            if [ "${FINAL_SHA:0:7}" != "${EXPECTED_SHORT}" ]; then
              echo "❌ Deployed SHA (${FINAL_SHA}) doesn't match expected (${EXPECTED_SHA}) after waiting."
              exit 1
            fi
          fi
