name: Playwright e2e

on:
  pull_request:
  push:
    branches:
      - main
  workflow_dispatch:

concurrency:
  group: playwright-e2e-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  vars:
    runs-on: ubuntu-latest
    outputs:
      skip_burn_in: ${{ steps.check_skip_label.outputs.skip_burn_in || 'false' }}
      test_env: dev
      test_command: npm run test:pw-local --
      install_command: npm ci
    steps:
      - name: Check for skip_burn_in label (PRs only)
        id: check_skip_label
        if: ${{ github.event_name == 'pull_request' || github.event_name == 'pull_request_target' }}
        run: |
          if [[ "${{ contains(github.event.pull_request.labels.*.name, 'skip_burn_in') }}" == "true" ]]; then
            echo "skip_burn_in=true" >> $GITHUB_OUTPUT
            echo "âœ… Found skip_burn_in label; skipping burn-in."
          else
            echo "skip_burn_in=false" >> $GITHUB_OUTPUT
            echo "No skip_burn_in label; running burn-in."
          fi

  burn-in:
    needs: vars
    if: ${{ github.event_name == 'pull_request' && needs.vars.outputs.skip_burn_in != 'true' }}
    uses: ./.github/workflows/rwf-burn-in.yml
    with:
      base-ref: 'main'
      test-directory: 'playwright/'
      install-command: ${{ needs.vars.outputs.install_command }}

  pw-e2e:
    needs: [vars, burn-in]
    timeout-minutes: 15
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        shardIndex: [1, 2]
        shardTotal: [2]
    if: |
      always() && (
        github.event_name != 'pull_request' ||
        needs.vars.outputs.skip_burn_in == 'true' ||
        (needs.burn-in.result == 'success' && needs.burn-in.outputs.runE2E == 'true') ||
        (needs.burn-in.result == 'skipped')
      )
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha || github.sha }}

      - name: Setup Node environment
        uses: ./.github/actions/setup-node-env
        with:
          use-npm-ci: 'true'

      - name: Cache Playwright browsers
        uses: actions/cache@v4
        with:
          path: ~/.cache/ms-playwright
          key: playwright-${{ runner.os }}-${{ github.sha }}
          restore-keys: |
            playwright-${{ runner.os }}-

      - name: Build web app
        run: npm run build --workspace web

      - name: Install Playwright Chromium only
        run: npx playwright install chromium

      - name: Run Playwright local suite
        run: npm run test:pw-local -- --shard=${{ matrix.shardIndex }}/${{ matrix.shardTotal }} --reporter=blob

      - name: Copy trace files to blob-report
        if: always()
        run: |
          mkdir -p blob-report/trace
          cp -r playwright/test-results/**/*.zip blob-report/trace || true

      - name: Upload Playwright artifacts (shard)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: blob-report-${{ matrix.shardIndex }}
          path: |
            blob-report
          retention-days: 5

  merge-reports:
    needs: pw-e2e
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node environment
        uses: ./.github/actions/setup-node-env
        with:
          use-npm-ci: 'true'

      - name: Download shard reports
        uses: actions/download-artifact@v4
        with:
          path: all-blob-reports
          pattern: blob-report-*
          merge-multiple: true

      - name: Merge Playwright reports
        run: |
          mkdir -p playwright-report/trace
          cp -r all-blob-reports/*/trace/* playwright-report/trace || true
          npx playwright merge-reports --reporter=html all-blob-reports

      - name: Upload merged report
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report
          path: playwright-report
          retention-days: 5

      - name: Generate summary
        if: always()
        run: |
          echo "## Playwright E2E" >> $GITHUB_STEP_SUMMARY
          echo "- Shards: 2" >> $GITHUB_STEP_SUMMARY
          echo "- Burn-in: ${{ needs.burn-in.result || 'skipped' }}" >> $GITHUB_STEP_SUMMARY
          echo "- Report: see uploaded artifact 'playwright-report'" >> $GITHUB_STEP_SUMMARY

      - name: Comment results on PR
        if: ${{ github.event_name == 'pull_request' }}
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            // Skip commenting on PRs from forks to avoid permissions issues
            if (context.payload.pull_request && context.payload.pull_request.head.repo.full_name !== context.payload.pull_request.base.repo.full_name) {
              core.info('Skipping PR comment for forked repository');
              return;
            }

            const runUrl = `${{ toJson(github.server_url) }}/${{ toJson(github.repository) }}/actions/runs/${{ github.run_id }}`;
            const burnInResult = '${{ needs.burn-in.result || 'skipped' }}';
            const e2eResult = '${{ needs.pw-e2e.result || 'unknown' }}';

            const body = [
              `Playwright E2E: **${e2eResult.toUpperCase()}** (burn-in: ${burnInResult})`,
              `Run: ${runUrl}`,
              '',
              '- Artifacts: download `playwright-report` for the merged HTML + traces',
              '- Shards: 2 (fail-fast: false)',
            ].join('\n');

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body,
            });
